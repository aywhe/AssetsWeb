<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8" />
    <title>播放视频</title>
    <link rel="stylesheet" href="css/play.css" />
</head>

<body>
    <script src="js/flv.min.js"></script>
    <script>
        const subtileExts = ['.vtt'];
        const videoExtMap = new Map([
            ['.rmvb', ''],
            ['.mkv', ''], // mkv格式，给的格式要为空，因为mkv只是容器，具体编码未知，有的mkv能播放有的不能
            ['.mp4', 'video/mp4'],
        ]);
        var queryString = window.location.search;
        var origin = window.location.origin;
        var pathname = window.location.pathname;
        var urlParams = new URLSearchParams(queryString);
        var fullPath = (urlParams.get('path'));
        var autoPlayFlag = urlParams.has('autoPlayFlag')?(urlParams.get('autoPlayFlag')):'false';
    </script>
    <div class="wrapper">
        <h2 id="til">
        </h2>
        <div class="video-container">
            <video id="video" controls autoplay>
                <source id="video_source" src="" type="">

                您的浏览器不支持视频播放。
            </video>
            <div id="add_container" class="add-container">
                <div id="auto_play_text">自动播放(关)：</div>
                <label for="auto_play_switch" class="switch">
                    <input type="checkbox" id="auto_play_switch">
                    <div class="checkbox-slider"></div>
                </label>
            </div>
            <hr>
        </div>

    </div>

    <script>
        function getFilePathExt2(filepath, defaultVal = '') {
            var lang = defaultVal;
            var arr = filepath.split(".");
            if (arr.length >= 3) {
                lang = arr[arr.length - 2];
            }
            return lang;
        }
        async function init() {
            var ext = fullPath.substring(fullPath.lastIndexOf('.')).toLowerCase();
            var videoSourceElement = document.getElementById("video_source");
            videoSourceElement.src = fullPath;
            videoSourceElement.type = videoExtMap.get(ext);
            document.getElementById("til").innerHTML = '正在播放 ' + fullPath;
            //console.log(fullPath);
            // 尝试添加字幕
            fetch('/api/lookfor-subtitles?path=' + encodeURIComponent(fullPath) + '&subtitleExts=' + encodeURIComponent(JSON.stringify(subtileExts)))
                .then(response => response.json())
                .then(data => {
                    if (data.subtitles.length > 0) {
                        var subtitles = data.subtitles;
                        const video = document.getElementById('video');
                        subtitles.forEach((val, ind) => {
                            var track = document.createElement('track');
                            track.src = val.file;
                            track.kind = "captions";
                            track.srclang = val.label;
                            track.label = val.label;
                            video.appendChild(track);
                        });
                    }
                })
                .catch(error => console.error('获取字幕失败:', error));
            // flv
            if ('.flv' === ext && flvjs.isSupported()) {
                try {
                    const video = document.getElementById('video');
                    const flvPlayer = flvjs.createPlayer({
                        type: 'flv',
                        url: fullPath
                    });
                    flvPlayer.attachMediaElement(video);
                    flvPlayer.load();
                    flvPlayer.play();
                } catch (error) {
                    console.error('flv 出错', error);
                    warning(error.message);
                }
            }
            // 获取播放列表
            fetch('/api/play-list?fullPath=' + encodeURIComponent(fullPath))
                .then(response => response.json())
                .then(name_list => {
                    name_list.sort();
                    var ind = name_list.indexOf(fullPath);
                    if (ind != -1) {
                        var button_container = document.getElementById("add_container");
                        // 有前一集
                        if (ind > 0) {
                            var btn_pre = document.createElement("button");
                            btn_pre.value = name_list[ind - 1];
                            btn_pre.addEventListener('click', function () {
                                
                                window.location.href = origin + pathname + '?path=' + encodeURIComponent(this.value) + '&autoPlayFlag=' + autoPlayFlag;
                            });
                            btn_pre.innerText = '前一集';
                            button_container.appendChild(btn_pre);
                        }
                        // 有后一集
                        if (ind < name_list.length - 1) {
                            var btn_next = document.createElement("button");
                            btn_next.value = name_list[ind + 1];
                            btn_next.id = 'btn_next';
                            btn_next.addEventListener('click', function () {
                                window.location.href = origin + pathname + '?path=' + encodeURIComponent(this.value) + '&autoPlayFlag=' + autoPlayFlag;
                            });
                            btn_next.innerText = '后一集';
                            button_container.appendChild(btn_next);
                            // 自动播放
                            const video = document.getElementById('video');
                            video.addEventListener('ended', function () {
                                var btn_next = document.getElementById('btn_next');
                                var auto_play_checked = document.getElementById('auto_play_switch');
                                if (undefined != btn_next && auto_play_checked.checked) {
                                    btn_next.click();
                                }
                            });
                        }
                        // 隐藏自动播放
                        if(ind == 0 && ind == name_list.length - 1){
                            var add_container = document.getElementById('add_container');
                            //add_container.style.visibility = 'hidden';
                            add_container.style.display = 'none';
                        }
                    } else {

                    }
                })
                .catch(error => console.error('获取播放列表失败:', error));
            // 修改自动播放文本
            var auto_play_checked = document.getElementById('auto_play_switch');
            // 修改自动播放文本
            auto_play_checked.addEventListener('change', function () {
                var auto_play_text = document.getElementById('auto_play_text');
                if (this.checked) {
                    auto_play_text.innerText = '自动播放(开)：';
                    autoPlayFlag = 'true';
                } else {
                    auto_play_text.innerText = '自动播放(关)：';
                    autoPlayFlag = 'false';
                }
            });
            
            // 传递自动播放参数
            if('true' == autoPlayFlag){
                auto_play_checked.checked = true;
            }else{
                auto_play_checked.checked = false;
            }
            const changeEvent = new Event('change');
            auto_play_checked.dispatchEvent(changeEvent);
        }

        init();
    </script>

</body>

</html>