<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8" />
    <title>文件列表</title>
    <link rel="stylesheet" href="css/asset-tree.css" />
</head>

<body>
    <div id="video-list">
        <h1>文件列表</h1>
    </div>
    <script src="js/js.cookie.min.js"></script>
</body>
<script>
    var queryString = window.location.search;
    var urlParams = new URLSearchParams(queryString);
    var key = urlParams.has('key') ? (urlParams.get('key')) : '';
    var hiddenTextListFlag = key + '-hiddenTextList';
    if(key.length > 0) {
        document.title = key + '-文件列表';
    }

    // 收起和展开的标题字符串
    function hiddenText(text){
        return text + ' ...';
    }
    function unHiddenText(text){
        return text.substr(0, text.length - 4);
    }

    // 收起和展开
    function setClickOptions() {
        // 设置点击函数
        document.querySelectorAll('.li-til').forEach(div => {
            div.title = '点击收起列表';
            div.addEventListener('click', function () {
                // 下一个ul节点
                let nextEle = this.nextElementSibling;
                if (nextEle && nextEle.tagName === 'UL') {
                    const isHidden = nextEle.classList.contains('hidden-ul');
                    nextEle.classList.toggle('hidden-ul', !isHidden);
                    if (!isHidden) {
                        this.textContent = hiddenText(this.textContent);
                        this.title = '点击展开列表';
                    }
                    else {
                        this.textContent = unHiddenText(this.textContent);
                        this.title = '点击收起列表';
                    }
                }
            });            
        });
        // 找到需要收起的列表
        var hiddenTextList = [];
        var hiddenTextListJson = Cookies.get(hiddenTextListFlag);
        if(hiddenTextListJson) {
            hiddenTextList = JSON.parse(hiddenTextListJson);
        }
        document.querySelectorAll('.li-til').forEach(div => {
            if(hiddenTextList.includes(div.textContent)){
                // 收起
                div.click();
            }
        });
    }

    // 递归生成 HTML 树结构
    function buildTreeHtml(nodes, pathTag, currentPath = []) {
        return `
            <ul>
            ${nodes.map(node => {
            const newPath = [...currentPath, node.name];
            if (node.children) {
                return `
                    <li>
                    <div class='li-til'>${node.name}</div>
                    ${buildTreeHtml(node.children, pathTag, newPath)}
                    </li>
                `;
            } else {
                // 文件节点，生成带完整路径的链接
                var fullPath = pathTag + '/' + newPath.join('/');
                return `
                    <li>
                    <a href="/play?path=${encodeURIComponent(fullPath)}" target="_blank">${node.name}</a>
                    </li>
                `;
            }
        }).join('')}
            </ul>
        `;
    }

    // 生成列表内容
    function genTreeInfoHtml(videoInfo, vpath) {
        return videoInfo.map((node, index) => `
            <div class="tree-root">
            <h3>${index + 1}: ${node.name} (${node.type})</h3>
            ${buildTreeHtml([node], vpath)}
            </div>
        `).join('');
    }

    // 获取信息
    if ((!(undefined === key)) && (!('' === key))) {
        fetch('/api/video-list?key=' + encodeURIComponent(key))
            .then(response => response.json())
            .then(data => {
                var videoInfo = data.videoInfo;
                var vpath = data.vpath;
                var videoInfoEle = document.getElementById('video-list');
                var text = genTreeInfoHtml(videoInfo, vpath);
                videoInfoEle.innerHTML = videoInfoEle.innerHTML + text;
                setClickOptions();
            })
            .catch(error => console.error('获取视频列表失败:', error));
    }
    else {
        fetch('/api/video-paths')
            .then(response => response.json())
            .then(data => {
                var videoPathList = data.videoPathList;
                var lis = videoPathList.map(val => {
                    return '<li>' + '<a href="/videos?key=' + encodeURIComponent(val.key) + '">' + val.vpath + '</a></li>';
                });
                var text = '<div class="tree-root"><ul>' + lis.join('') + '</ul></div>';
                var videoInfoEle = document.getElementById('video-list');
                videoInfoEle.innerHTML = videoInfoEle.innerHTML + text;
            })
            .catch(error => console.error('获取视频目录失败:', error));
    }
    // 关闭页面时保存 cookie
    window.addEventListener('beforeunload', function(event) {
        var hiddenTextList = Array.from(document.querySelectorAll('.li-til')).filter((div) => {
            // 下一个ul节点
            let nextEle = div.nextElementSibling;
            return (nextEle && nextEle.tagName === 'UL' && nextEle.classList.contains('hidden-ul'));
        }).map((div) => {
            return unHiddenText(div.textContent);
        });
        if(hiddenTextList.length > 0){
            Cookies.set(hiddenTextListFlag, JSON.stringify(hiddenTextList), {path: ''});
        } else {
            Cookies.remove(hiddenTextListFlag, {path: ''});
        }
    });
</script>

</html>